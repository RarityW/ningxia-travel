// å®å¤æ–‡æ—… - é¦–é¡µ
Page({
  data: {
    // å®æ—¶æ°”æ¸©
    temperature: '12Â°C',
    weatherIcon: 'â˜€',
    // åŠŸèƒ½å…¥å£å›¾æ ‡
    functionIcons: [
      { id: 1, name: 'éé—', icon: '/assets/feiyi.png', page: '/pages/culture/list' },
      { id: 2, name: 'æ–‡åˆ›', icon: '/assets/wenchuang.png', page: '/pages/culture/list' },
      { id: 3, name: 'æ™¯åŒº', icon: '/assets/jingqu.png', page: '/pages/attractions/list' },
      { id: 4, name: 'é…’åº—', icon: '/assets/jiudian.png', page: '' },
      { id: 5, name: 'æ°‘å®¿', icon: '/assets/minsu.png', page: '' },
      { id: 6, name: 'ç¾é£Ÿ', icon: '/assets/meishi.png', page: '/pages/food/list' }
    ],
    // ä¼˜æƒ æ´»åŠ¨å…¬å‘Š
    notices: [
      '2025å¹´å®å¤æ–‡æ—…ä¼˜æƒ æ´»åŠ¨æŒç»­å¼€å±•ä¸­',
      'å®å¤æ–‡æ—…ä¼ä¸šä¼˜æƒ æ´»åŠ¨ç«çƒ­è¿›è¡Œ'
    ],
    // äº§å“åˆ†ç±»
    categories: ['å…¨éƒ¨', 'éé—äº§å“', 'æ–‡åˆ›å‘¨è¾¹', 'ç‰¹è‰²é£Ÿå“'],
    currentCategory: 'å…¨éƒ¨',
    // ç²¾é€‰äº§å“
    products: [
      {
        id: 1,
        name: 'å®å¤æ¸æ',
        image: 'https://via.placeholder.com/300x300/FF6B6B/FFFFFF?text=æ¸æ',
        category: 'éé—äº§å“',
        price: 98,
        sales: 520
      },
      {
        id: 2,
        name: 'å®å¤è‘¡è„é…’',
        image: 'https://via.placeholder.com/300x300/722F37/FFFFFF?text=è‘¡è„é…’',
        category: 'æ˜æ˜Ÿäº§å“',
        price: 168,
        sales: 386
      },
      {
        id: 3,
        name: 'å…«å®èŒ¶ç¤¼ç›’',
        image: 'https://via.placeholder.com/300x300/228B22/FFFFFF?text=å…«å®èŒ¶',
        category: 'ç‰¹è‰²é£Ÿå“',
        price: 88,
        sales: 892
      },
      {
        id: 4,
        name: 'è´ºå…°çŸ³ç š',
        image: 'https://via.placeholder.com/300x300/708090/FFFFFF?text=è´ºå…°ç š',
        category: 'æ–‡åˆ›å‘¨è¾¹',
        price: 588,
        sales: 156
      },
      {
        id: 5,
        name: 'å›æ—åˆºç»£',
        image: 'https://via.placeholder.com/300x300/DC143C/FFFFFF?text=åˆºç»£',
        category: 'éé—äº§å“',
        price: 368,
        sales: 243
      },
      {
        id: 6,
        name: 'æ²™å¡å¤´æ–‡åˆ›',
        image: 'https://via.placeholder.com/300x300/DEB887/FFFFFF?text=æ–‡åˆ›',
        category: 'æ–‡åˆ›å‘¨è¾¹',
        price: 128,
        sales: 567
      }
    ],
    filteredProducts: [],
    cartCount: 0
  },
      {
        id: 2,
        title: 'è¥¿å¤ç‹é™µ',
        desc: 'æ¢å¯»åƒå¹´è¥¿å¤ç‹æœçš„ç¥ç§˜',
        color1: 'var(--primary-green)',
        color2: 'var(--primary-light)',
        image: '/images/banner2.jpg'
      }
    ],
    // çƒ­é—¨æ™¯ç‚¹
    hotAttractions: [],
    // æ¨èç¾é£Ÿ
    hotFood: [],
    // æ¨èå¥½ç¤¼
    gifts: [
      {
        id: 1,
        name: 'å®å¤æ¸æ',
        image: 'https://via.placeholder.com/500x500/FF6B6B/FFFFFF?text=æ¸æ',
        category: 'æ˜æ˜Ÿäº§å“',
        price: 98
      },
      {
        id: 2,
        name: 'å®å¤è‘¡è„é…’',
        image: 'https://via.placeholder.com/500x500/722F37/FFFFFF?text=è‘¡è„é…’',
        category: 'æ˜æ˜Ÿäº§å“',
        price: 168
      },
      {
        id: 3,
        name: 'å…«å®èŒ¶ç¤¼ç›’',
        image: 'https://via.placeholder.com/500x500/228B22/FFFFFF?text=å…«å®èŒ¶',
        category: 'ç‰¹è‰²é£Ÿå“',
        price: 88
      },
      {
        id: 4,
        name: 'è´ºå…°çŸ³ç š',
        image: 'https://via.placeholder.com/500x500/708090/FFFFFF?text=è´ºå…°ç š',
        category: 'æ–‡åˆ›å‘¨è¾¹',
        price: 588
      }
    ]
  },

  onLoad() {
    this.loadWeather();
    this.filterProducts();
    this.loadCartCount();
  },

  onShow() {
    this.loadCartCount();
  },

  onShareAppMessage() {
    return {
      title: 'å®å¤æ–‡æ—… - å‘ç°å®å¤ä¹‹ç¾',
      path: '/pages/index/index'
    };
  },

  // åŠ è½½å¤©æ°”æ•°æ®
  loadWeather() {
    // é«˜å¾·åœ°å›¾API Keyï¼ˆè¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„Keyï¼‰
    const AMAP_KEY = 'YOUR_AMAP_KEY';

    wx.getLocation({
      type: 'wgs84',
      success: (res) => {
        const { latitude, longitude } = res;
        wx.request({
          url: 'https://restapi.amap.com/v3/weather/weatherInfo',
          data: {
            key: AMAP_KEY,
            city: '640000', // å®å¤è¡Œæ”¿åŒºåˆ’ä»£ç 
            extensions: 'base'
          },
          success: (res) => {
            if (res.data && res.data.lives && res.data.lives.length > 0) {
              const lives = res.data.lives[0];
              this.setData({
                temperature: `${lives.temperature}Â°C`,
                weatherIcon: this.getWeatherIcon(lives.weather)
              });
            }
          },
          fail: () => {
            // APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            this.setMockWeather();
          }
        });
      },
      fail: () => {
        // è·å–ä½ç½®å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        this.setMockWeather();
      }
    });
  },

  // æ¨¡æ‹Ÿå¤©æ°”æ•°æ®ï¼ˆå½“APIä¸å¯ç”¨æ—¶ä½¿ç”¨ï¼‰
  setMockWeather() {
    const mockData = {
      temperature: Math.floor(Math.random() * 20 + 5), // 5-25Â°Céšæœº
      weatherTypes: ['æ™´', 'å¤šäº‘', 'é˜´', 'é›¨', 'é›ª'],
      weather: this.getMockWeatherCondition()
    };
    this.setData({
      temperature: `${mockData.temperature}Â°C`,
      weatherIcon: this.getWeatherIcon(mockData.weather)
    });
  },

  // è·å–æ¨¡æ‹Ÿå¤©æ°”çŠ¶å†µ
  getMockWeatherCondition() {
    const conditions = ['æ™´', 'å¤šäº‘', 'é˜´', 'å°é›¨', 'é›ª'];
    const month = new Date().getMonth();
    // æ ¹æ®å­£èŠ‚è°ƒæ•´å¤©æ°”æ¦‚ç‡
    if (month >= 5 && month <= 9) {
      return Math.random() > 0.3 ? 'æ™´' : conditions[Math.floor(Math.random() * 3)];
    }
    return conditions[Math.floor(Math.random() * conditions.length)];
  },

  // æ ¹æ®å¤©æ°”æè¿°è¿”å›å›¾æ ‡
  getWeatherIcon(weather) {
    const iconMap = {
      'æ™´': 'â˜€',
      'å¤šäº‘': 'â›…',
      'é˜´': 'â˜',
      'é›¨': 'ğŸŒ§',
      'é›ª': 'â„',
      'é›·é˜µé›¨': 'â›ˆ',
      'é›¾': 'ğŸŒ«'
    };
    return iconMap[weather] || 'â˜€';
  },

  // åŠ è½½çƒ­é—¨æ•°æ®ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰
  async loadHotData() {
    // ç›´æ¥ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
    const mockAttractions = [
      {
        id: '1',
        name: 'æ²™å¡å¤´æ™¯åŒº',
        englishName: 'Shapotou Scenic Area',
        coverImage: 'https://via.placeholder.com/750x360/DEB887/FFFFFF?text=æ²™å¡å¤´',
        images: [
          'https://via.placeholder.com/750x500/DEB887/FFFFFF?text=æ²™å¡å¤´1',
          'https://via.placeholder.com/750x500/D2691E/FFFFFF?text=æ²™å¡å¤´2'
        ],
        grade: '5A',
        category: 'è‡ªç„¶',
        region: 'ä¸­å«å¸‚',
        address: 'å®å¤ä¸­å«å¸‚æ²™å¡å¤´åŒºè¿æ°´æ¡¥é•‡',
        description: 'æ²™å¡å¤´æ™¯åŒºä½äºå®å¤ä¸­å«å¸‚åŸåŒºä»¥è¥¿20å…¬é‡Œçš„è…¾æ ¼é‡Œæ²™æ¼ ä¸œå—è¾¹ç¼˜å¤„ï¼Œè¿™é‡Œé›†å¤§æ¼ ã€é»„æ²³ã€é«˜å±±ã€ç»¿æ´²ä¸ºä¸€å¤„ï¼Œå…·è¥¿åŒ—é£å…‰ä¹‹é›„å¥‡ï¼Œå…¼æ±Ÿå—æ™¯è‰²ä¹‹ç§€ç¾ã€‚',
        features: ['æ²™æ¼ æ»‘æ²™', 'é»„æ²³æ¼‚æµ', 'éª‘éª†é©¼', 'æ²™æµ·å†²æµª', 'ç¾Šçš®ç­å­'],
        openTime: '08:00-18:00',
        ticketPrice: 80,
        phone: '0955-7689333',
        latitude: 37.5167,
        longitude: 105.0167,
        views: 15000,
        rating: 4.8,
        recommend: true,
        tags: ['æ²™æ¼ ', 'é»„æ²³', 'å¿…æ‰“å¡', '5Açº§æ™¯åŒº']
      },
      {
        id: '2',
        name: 'é•‡åŒ—å ¡è¥¿éƒ¨å½±åŸ',
        englishName: 'Zhenbeipu Western Film City',
        coverImage: 'https://via.placeholder.com/750x360/DAA520/FFFFFF?text=é•‡åŒ—å ¡',
        images: [
          'https://via.placeholder.com/750x500/DAA520/FFFFFF?text=é•‡åŒ—å ¡1'
        ],
        grade: '5A',
        category: 'æ–‡åŒ–',
        region: 'é“¶å·å¸‚',
        address: 'å®å¤é“¶å·å¸‚è¥¿å¤åŒºé•‡åŒ—å ¡é•‡',
        description: 'é•‡åŒ—å ¡è¥¿éƒ¨å½±åŸæ˜¯ä¸­å›½åå¤§å½±è§†åŸºåœ°ä¹‹ä¸€ï¼Œæ˜¯å¤§è¯è¥¿æ¸¸ã€çº¢é«˜ç²±ã€æ–°é¾™é—¨å®¢æ ˆç­‰ç™¾ä½™éƒ¨å½±è§†ä½œå“çš„å–æ™¯åœ°ã€‚',
        features: ['å½±è§†æ‹æ‘„', 'å¤è£…ä½“éªŒ', 'æ°‘ä¿—æ–‡åŒ–', 'æ‘„å½±'],
        openTime: '08:00-18:00',
        ticketPrice: 80,
        phone: '0951-2136060',
        latitude: 38.5167,
        longitude: 106.0833,
        views: 18000,
        rating: 4.9,
        recommend: true,
        tags: ['å½±è§†', '5Açº§æ™¯åŒº', 'å¤§è¯è¥¿æ¸¸', 'å¿…æ‰“å¡']
      }
    ];

    const mockFoods = [
      {
        id: '1',
        name: 'æ‰‹æŠ“ç¾Šè‚‰',
        region: 'é“¶å·å¸‚',
        price: 120,
        coverImage: 'https://via.placeholder.com/240x180/FFA07A/FFFFFF?text=æ‰‹æŠ“ç¾Šè‚‰'
      },
      {
        id: '2',
        name: 'ç¾Šæ‚ç¢',
        region: 'å´å¿ å¸‚',
        price: 35,
        coverImage: 'https://via.placeholder.com/240x180/FF7F50/FFFFFF?text=ç¾Šæ‚ç¢'
      },
      {
        id: '3',
        name: 'æ²™æ¹–å¤§é±¼å¤´',
        region: 'çŸ³å˜´å±±å¸‚',
        price: 168,
        coverImage: 'https://via.placeholder.com/240x180/4682B4/FFFFFF?text=æ²™æ¹–å¤§é±¼å¤´'
      },
      {
        id: '4',
        name: 'æ²¹é¦™',
        region: 'é“¶å·å¸‚',
        price: 5,
        coverImage: 'https://via.placeholder.com/240x180/DAA520/FFFFFF?text=æ²¹é¦™'
      }
    ];

    this.setData({
      hotAttractions: mockAttractions,
      hotFood: mockFoods
    });
  },

  // é‡‘åˆšåŒºç‚¹å‡»
  onDiamondTap(e) {
    const { id, page } = e.currentTarget.dataset;
    if (page) {
      wx.navigateTo({
        url: page
      });
    } else {
      wx.showToast({
        title: 'åŠŸèƒ½å¼€å‘ä¸­',
        icon: 'none'
      });
    }
  },

  // è·³è½¬æ™¯ç‚¹åˆ—è¡¨
  goToAttractions() {
    wx.navigateTo({
      url: '/pages/attractions/list'
    });
  },

  // è·³è½¬æ™¯ç‚¹è¯¦æƒ…
  goToAttractionDetail(e) {
    const { id } = e.currentTarget.dataset;
    wx.navigateTo({
      url: `/pages/attractions/detail?id=${id}`
    });
  },

  // è·³è½¬ç¾é£Ÿåˆ—è¡¨
  goToFood() {
    wx.navigateTo({
      url: '/pages/food/list'
    });
  },

  // è·³è½¬ç¾é£Ÿè¯¦æƒ…
  goToFoodDetail(e) {
    const { id } = e.currentTarget.dataset;
    wx.navigateTo({
      url: `/pages/food/detail?id=${id}`
    });
  },

  // è·³è½¬å•†åŸ
  goToMarket() {
    wx.navigateTo({
      url: '/pages/market/index'
    });
  },

  // è·³è½¬å¥½ç¤¼è¯¦æƒ…
  goToGiftDetail(e) {
    const { id } = e.currentTarget.dataset;
    wx.navigateTo({
      url: `/pages/market/detail?id=${id}`
    });
  },

  // ç­›é€‰äº§å“
  filterProducts() {
    const { products, currentCategory } = this.data;
    if (currentCategory === 'å…¨éƒ¨') {
      this.setData({ filteredProducts: products });
    } else {
      this.setData({
        filteredProducts: products.filter(p => p.category === currentCategory)
      });
    }
  },

  // åˆ‡æ¢åˆ†ç±»
  switchCategory(e) {
    const category = e.currentTarget.dataset.category;
    this.setData({
      currentCategory: category
    });
    this.filterProducts();
  },

  // è·³è½¬äº§å“è¯¦æƒ…
  goToProductDetail(e) {
    const { id } = e.currentTarget.dataset;
    wx.navigateTo({
      url: `/pages/market/detail?id=${id}`
    });
  },

  // åˆ‡æ¢å®šä½
  switchLocation() {
    wx.getLocation({
      type: 'wgs84',
      success: (res) => {
        wx.showToast({
          title: 'å®šä½æˆåŠŸ',
          icon: 'success'
        });
      },
      fail: () => {
        wx.showModal({
          title: 'æç¤º',
          content: 'éœ€è¦è·å–æ‚¨çš„åœ°ç†ä½ç½®ä¿¡æ¯',
          confirmText: 'å»è®¾ç½®',
          success: (res) => {
            if (res.confirm) {
              wx.openSetting();
            }
          }
        });
      }
    });
  },

  // åŠŸèƒ½å…¥å£ç‚¹å‡»
  onFunctionTap(e) {
    const { page } = e.currentTarget.dataset;
    if (page) {
      wx.navigateTo({
        url: page
      });
    } else {
      wx.showToast({
        title: 'åŠŸèƒ½å¼€å‘ä¸­',
        icon: 'none'
      });
    }
  },

  // è·³è½¬æ¶ˆè´¹åˆ¸é¢†å–
  goToCoupon() {
    wx.showToast({
      title: 'åŠŸèƒ½å¼€å‘ä¸­',
      icon: 'none'
    });
  },

  // è·³è½¬ä¸ªäººä¸­å¿ƒ
  goToProfile() {
    wx.switchTab({
      url: '/pages/profile/profile'
    });
  },

  // åŠ è½½è´­ç‰©è½¦æ•°é‡
  loadCartCount() {
    const cart = wx.getStorageSync('cart') || [];
    const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
    this.setData({ cartCount });
  },

  // æœç´¢
  onSearch(e) {
    const keyword = e.detail.value;
    if (keyword.trim()) {
      wx.navigateTo({
        url: `/pages/attractions/list?keyword=${keyword}`
      });
    }
  }
});
